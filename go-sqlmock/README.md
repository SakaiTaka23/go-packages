# go-sqlmock

## 使い方の流れ

1. sqlmock.NewでMockを作成
   返り値はdb, mock, err
   dbはDB接続が行われた変数
   mockは返り値を設定するための変数
   テストの関数内ではなくDBとモックを返す専用の関数を使った方が良さそう
   関数内でDBクライアントを作るようにすると良い
2. それぞれの変数に対して関数を実行していく
   mockにはどいう行ったクエリが走るべきなのかを定義
   dbには実際のコネクションを作成・テスト対象の関数を実行する
3. 返り値と実行クエリの確認
   - `ExpectationsWereMet`によって実際に実行されたクエリと定義したクエリが一致しているかを確認
   - `assert`関数などを使って返り値が予想されたものと一致しているかを確認

## Mockの操作

参考: https://qiita.com/gold-kou/items/cb174690397f651e2d7f
- Selectとそれ以外でクエリの記述関数が変わってくる
- クエリは正規表現なので一部あっていればokといったテストも行うこともできる
- 少なすぎたらテストの意味がないので良く考える
- SQLの引数は`WithArgs`で設定する
- select系の場合`WillReturnRows`によって返り値をどのようにするのか定義することができて実際にその値が返されるので事前にモックデータを入れる必要はない

## 感想

### よかった点

テストの際にDBに接続する必要がないのでテストが早い

良くも悪くもORMのブラックボックス化を回避できる
→モデルなどが変わって発行されるクエリが変わってもテストでそれを検知できる
→ORMのありがたみが薄れるという解釈もできる

### 悪かった点

このテスト自体は意図したSQLが引数の結果を含めて正しい順番で実行されているかを確認している。
→モックからありえない値を返したりSQL上に文法エラーがあったりを検知することができない

ドキュメントがかなり少ない
